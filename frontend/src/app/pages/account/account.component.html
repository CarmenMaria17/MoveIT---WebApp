<div class="account-container">
  <ng-container *ngIf="authService.isAuthenticated(); else guestState">
    <!-- Main Content Layout: Favorites Left, Calendar Center -->
    <div class="main-content-layout">
      <!-- Favorites Section - Left -->
      <div class="favorites-container">
        <div class="favorites-section">
          <div class="section-header">
            <h3>My Favorite Centers</h3>
          </div>

          <div *ngIf="loadingFavorites" class="loading">Loading favorites...</div>

          <div *ngIf="!loadingFavorites && favoriteCenters.length === 0" class="no-favorites">
            <p>You don't have any favorite centers yet.</p>
            <a routerLink="/map" class="link-btn">Browse Centers</a>
          </div>

          <div *ngIf="!loadingFavorites && favoriteCenters.length > 0" class="favorites-list">
            <div *ngFor="let favorite of favoriteCenters" class="favorite-card">
              <div class="favorite-info">
                <h4>{{ favorite.center.name || 'Unnamed Center' }}</h4>
                <p class="category" *ngIf="favorite.center.category">
                  {{ favorite.center.category }}
                </p>
                <div class="center-rating" *ngIf="favorite.center['rating']" (click)="openReviewsModal(favorite.center)" style="cursor: pointer;">
                  <span class="rating-stars">‚òÖ</span>
                  <span class="rating-value">{{ favorite.center['rating'].toFixed(1) }}</span>
                  <span class="rating-count" *ngIf="favorite.center['reviewCount']">
                    ({{ favorite.center['reviewCount'] }})
                  </span>
                </div>
                <p class="address" *ngIf="favorite.center.address">
                  {{ favorite.center.address }}
                </p>
              </div>
              <div class="favorite-actions">
                <button
                  class="reserve-favorite-btn"
                  (click)="openReservationModal(favorite.center)"
                  title="Make reservation">
                  Reserve
                </button>
                <button
                  class="remove-favorite-btn"
                  (click)="removeFavorite(favorite.centerId)"
                  title="Remove from favorites">
                  ‚ô•
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Calendar Section - Center -->
      <div class="calendar-container-wrapper">
        <div class="calendar-section">
          <div class="section-header">
            <h3>My Reservations</h3>
            <div class="view-toggle">
              <button 
                class="toggle-btn" 
                [class.active]="viewMode === 'list'"
                (click)="viewMode = 'list'">
                List
              </button>
              <button 
                class="toggle-btn" 
                [class.active]="viewMode === 'calendar'"
                (click)="viewMode = 'calendar'">
                Calendar
              </button>
            </div>
          </div>

          <div *ngIf="loading" class="loading">Loading reservations...</div>

          <!-- List View -->
          <div *ngIf="!loading && viewMode === 'list'" class="reservations-list">
            <div *ngIf="reservations.length === 0" class="no-reservations">
              <p>You don't have any reservations yet.</p>
              <a routerLink="/map" class="link-btn">Browse Centers</a>
            </div>

            <!-- Current Reservations -->
            <div *ngIf="getCurrentReservations().length > 0">
              <h4 class="reservation-section-title">Current Reservations</h4>
              <div *ngFor="let reservation of getCurrentReservations()" class="reservation-card">
                <div class="reservation-info">
                  <h4>{{ reservation.centerName }}</h4>
                  <div class="reservation-details">
                    <span class="date-badge">
                      üìÖ {{ reservation.date }}
                    </span>
                    <span class="time-badge">
                      üïê {{ reservation.hour }}
                    </span>
                    <span class="status-badge" [ngClass]="getStatusClass(reservation.status)">
                      {{ reservation.status }}
                    </span>
                  </div>
                </div>
                <div class="reservation-actions" *ngIf="canCancel(reservation)">
                  <button class="cancel-btn" (click)="openCancelConfirm(reservation)">
                    Cancel
                  </button>
                </div>
              </div>
            </div>

            <!-- Past Reservations -->
            <div *ngIf="getPastReservations().length > 0" class="past-reservations-section">
              <h4 class="reservation-section-title">Past Reservations</h4>
              <div *ngFor="let reservation of getPastReservations()" class="reservation-card past">
                <div class="reservation-info">
                  <h4>{{ reservation.centerName }}</h4>
                  <div class="reservation-details">
                    <span class="date-badge">
                      üìÖ {{ reservation.date }}
                    </span>
                    <span class="time-badge">
                      üïê {{ reservation.hour }}
                    </span>
                    <span class="status-badge" [ngClass]="getStatusClass(reservation.status)">
                      {{ reservation.status }}
                    </span>
                  </div>
                </div>
                <div class="reservation-actions">
                  <button
                    *ngIf="canReview(reservation)"
                    class="review-btn"
                    (click)="openReviewModal(reservation)">
                    Leave Review
                  </button>
                  <span *ngIf="hasReviewed(reservation)" class="reviewed-badge">
                    ‚úì Reviewed
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Calendar View -->
          <div *ngIf="!loading && viewMode === 'calendar'" class="calendar-view">
            <div *ngIf="reservations.length === 0" class="no-reservations">
              <p>You don't have any reservations yet.</p>
              <a routerLink="/map" class="link-btn">Browse Centers</a>
            </div>

            <div *ngIf="reservations.length > 0" class="calendar-layout">
              <!-- Calendar - Left Side -->
              <div class="calendar-container">
                <div class="calendar-header">
                  <button class="nav-btn" (click)="previousMonth()">‚Äπ</button>
                  <h4>{{ selectedMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) }}</h4>
                  <button class="nav-btn" (click)="nextMonth()">‚Ä∫</button>
                </div>

                <div class="calendar-grid">
                  <div class="calendar-weekday">Sun</div>
                  <div class="calendar-weekday">Mon</div>
                  <div class="calendar-weekday">Tue</div>
                  <div class="calendar-weekday">Wed</div>
                  <div class="calendar-weekday">Thu</div>
                  <div class="calendar-weekday">Fri</div>
                  <div class="calendar-weekday">Sat</div>

                  <ng-container *ngFor="let day of getCalendarDays()">
                    <div
                      class="calendar-day"
                      (click)="selectDay(day)"
                      [class.other-month]="day.getMonth() !== selectedMonth.getMonth()"
                      [class.today]="isToday(day)"
                      [class.selected-day]="selectedDay === formatDate(day)"
                      [class.has-reservation]="getReservationsForDate(formatDate(day)).length > 0"
                      [class.past-date]="isPastDate(day) && day.getMonth() === selectedMonth.getMonth()">
                      <div class="day-number">{{ day.getDate() }}</div>
                      <div class="reservation-dots">
                        <span
                          *ngFor="let reservation of getReservationsForDate(formatDate(day))"
                          class="reservation-dot"
                          [title]="reservation.centerName + ' at ' + reservation.hour">
                        </span>
                      </div>
                    </div>
                  </ng-container>
                </div>
              </div>

              <!-- Reservation Details - Right Side -->
              <div class="month-reservations">
                <div class="reservations-header">
                  <h5>
                    <span *ngIf="!selectedDay">Reservations in {{ selectedMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) }}</span>
                    <span *ngIf="selectedDay">Reservations on {{ selectedDay }}</span>
                  </h5>
                  <button *ngIf="selectedDay" class="show-all-btn" (click)="showAllReservations()">
                    Show All
                  </button>
                </div>
                <div class="reservations-list">
                  <div
                    *ngFor="let reservation of getReservationsForSelectedMonth()"
                    class="reservation-card small"
                    [class.past]="isReservationPast(reservation.date)">
                    <div class="reservation-info">
                      <h4>{{ reservation.centerName }}</h4>
                      <div class="reservation-details">
                        <span class="date-badge">üìÖ {{ reservation.date }}</span>
                        <span class="time-badge">üïê {{ reservation.hour }}</span>
                        <span class="status-badge" [ngClass]="getStatusClass(reservation.status)">
                          {{ reservation.status }}
                        </span>
                      </div>
                    </div>
                    <div class="reservation-actions" *ngIf="canCancel(reservation)">
                      <button class="cancel-btn small" (click)="openCancelConfirm(reservation)">
                        Cancel
                      </button>
                    </div>
                  </div>
                  <div *ngIf="getReservationsForSelectedMonth().length === 0" class="no-reservations">
                    <p *ngIf="!selectedDay">No reservations for this month.</p>
                    <p *ngIf="selectedDay">No reservations for this day.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #guestState>
    <div class="guest-container">
      <p class="muted">You are not logged in.</p>
      <a class="primary link-btn" routerLink="/login">Go to Login</a>
    </div>
  </ng-template>

  <!-- Cancel Confirmation Modal -->
  <div class="modal-overlay" *ngIf="showCancelConfirm" (click)="closeCancelConfirm()">
    <div class="confirm-modal" (click)="$event.stopPropagation()">
      <h3>Cancel Reservation</h3>
      <p *ngIf="reservationToCancel">
        Are you sure you want to cancel your reservation at <strong>{{ reservationToCancel.centerName }}</strong>
        on <strong>{{ reservationToCancel.date }}</strong> at <strong>{{ reservationToCancel.hour }}</strong>?
      </p>
      <p class="warning-text">This action cannot be undone.</p>
      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeCancelConfirm()" [disabled]="loading">
          No, Keep It
        </button>
        <button class="btn-danger" (click)="confirmCancel()" [disabled]="loading">
          {{ loading ? 'Cancelling...' : 'Yes, Cancel' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Reservation Modal -->
  <div class="modal-overlay" *ngIf="showReservationModal" (click)="closeReservationModal()">
    <div class="confirm-modal reservation-modal" (click)="$event.stopPropagation()">
      <h3>Make a Reservation</h3>
      <div class="form-group">
        <label>Center:</label>
        <p class="center-name">{{ selectedCenterForReservation?.name || 'Unnamed Center' }}</p>
      </div>

      <div class="form-group">
        <label for="reservationDate">Date:</label>
        <input
          type="date"
          id="reservationDate"
          [(ngModel)]="reservationDate"
          (ngModelChange)="updateAvailableSpots()"
          [min]="getMinDate()"
          required
          class="form-input"
        />
      </div>

      <div class="form-group">
        <label for="reservationHour">Hour:</label>
        <select
          id="reservationHour"
          [(ngModel)]="reservationHour"
          (ngModelChange)="updateAvailableSpots()"
          required
          class="form-input"
        >
          <option value="">Select an hour</option>
          <option *ngFor="let hour of availableHours" [value]="hour">
            {{ hour }}
          </option>
        </select>
      </div>

      <!-- Available Spots Display -->
      <div *ngIf="availableSpots !== null && totalCapacity !== null" class="availability-info">
        <span class="availability-label">Available spots:</span>
        <span class="availability-value" [class.low-availability]="availableSpots < totalCapacity * 0.3">
          {{ availableSpots }}/{{ totalCapacity }}
        </span>
      </div>

      <div *ngIf="reservationError" class="error-message">
        {{ reservationError }}
      </div>

      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeReservationModal()" [disabled]="loading">
          Cancel
        </button>
        <button class="btn-primary" (click)="submitReservation()" [disabled]="loading">
          {{ loading ? 'Creating...' : 'Create Reservation' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Review Modal -->
<div *ngIf="showReviewModal" class="modal-overlay" (click)="closeReviewModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Leave a Review</h3>
      <button class="close-btn" (click)="closeReviewModal()">√ó</button>
    </div>

    <div class="modal-body">
      <div *ngIf="reservationToReview" class="review-details">
        <p><strong>Center:</strong> {{ reservationToReview.centerName }}</p>
        <p><strong>Date:</strong> {{ reservationToReview.date }} at {{ reservationToReview.hour }}</p>
      </div>

      <div class="form-group">
        <label for="reviewRating">Rating:</label>
        <div class="star-rating">
          <span
            *ngFor="let star of [1, 2, 3, 4, 5]"
            class="star"
            [class.filled]="star <= reviewRating"
            (click)="reviewRating = star">
            ‚òÖ
          </span>
        </div>
      </div>

      <div class="form-group">
        <label for="reviewComment">Comment (optional):</label>
        <textarea
          id="reviewComment"
          [(ngModel)]="reviewComment"
          placeholder="Share your experience..."
          rows="4"
          class="form-input"
        ></textarea>
      </div>

      <div *ngIf="reviewError" class="error-message">
        {{ reviewError }}
      </div>

      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeReviewModal()" [disabled]="loading">
          Cancel
        </button>
        <button class="btn-primary" (click)="submitReview()" [disabled]="loading">
          {{ loading ? 'Submitting...' : 'Submit Review' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Reviews Modal -->
<app-reviews-modal
  [centerId]="reviewsCenterId"
  [centerName]="reviewsCenterName"
  [show]="showReviewsModal"
  (closeModal)="closeReviewsModal()">
</app-reviews-modal>
